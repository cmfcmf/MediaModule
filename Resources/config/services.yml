imports:
  - { resource: 'mediatypes.yml' }
  - { resource: 'collectiontemplates.yml' }
  - { resource: 'collectionpermissions.yml' }
  - { resource: 'formtypes.yml' }
  - { resource: 'hooks.yml' }
  - { resource: 'importers.yml' }

services:
    # Imagine filter
    cmfcmf_media_module.filter.custom_image_filter:
        class: Cmfcmf\Module\MediaModule\Imagine\Filter\Loader\CustomImageFilter
        arguments:
            - '@liip_imagine'
            - '@doctrine.orm.default_entity_manager'
            - '@cmfcmf_media_module.font_collection'
        tags:
            - { name: 'liip_imagine.filter.loader', loader: cmfcmfmediamodule.custom_image_filter }

    # Security management
    cmfcmf_media_module.security_manager:
        class: Cmfcmf\Module\MediaModule\Security\SecurityManager
        arguments:
            - '@translator'
            - '@zikula_permissions_module.api.permission'
            - '@doctrine.orm.default_entity_manager'
            - '@cmfcmf_media_module.collection_permission.container'

    # Module upgrader and version checker
    cmfcmf_media_module.upgrade.module_upgrader:
        class: Cmfcmf\Module\MediaModule\Upgrade\ModuleUpgrader
        arguments:
            - '@translator'
            - '@filesystem'
            - '@event_dispatcher'
            - '@zikula_extensions_module.extension_repository'
            - '@zikula_extensions_module.bundle_sync_helper'
            - '@zikula_extensions_module.extension_helper'
            - '@zikula.cache_clearer'
            - '%kernel.cache_dir%'
            - '%kernel.root_dir%'

    cmfcmf_media_module.upgrade.version_checker:
        class: Cmfcmf\Module\MediaModule\Upgrade\VersionChecker
        arguments:
            - '%kernel.cache_dir%'

    # Helpers
    cmfcmf_media_module.search_helper:
        class: Cmfcmf\Module\MediaModule\Helper\SearchHelper
        arguments:
            - '@request_stack'
            - '@cmfcmf_media_module.security_manager'

    # Listeners
    cmfcmf_media_module.listener.doctrine:
        class: Cmfcmf\Module\MediaModule\Listener\DoctrineListener
        tags: ['doctrine.event_subscriber']

    cmfcmf_media_module.listener.entity_lifecycle:
        class: Cmfcmf\Module\MediaModule\Listener\EntityLifecycleListener
        arguments:
            - '@service_container'
        tags: ['doctrine.event_subscriber']

    cmfcmf_media_module.listener.module:
        class: Cmfcmf\Module\MediaModule\Listener\ModuleListener
        arguments:
            - '@doctrine.orm.default_entity_manager'
        tags: ['kernel.event_subscriber']

    cmfcmf_media_module.listener.thirdparty:
        class: Cmfcmf\Module\MediaModule\Listener\ThirdPartyListener
        arguments:
            - '@filesystem'
            - '@request_stack'
        tags: ['kernel.event_subscriber']

    # Link container
    cmfcmf_media_module.container.links:
        class: Cmfcmf\Module\MediaModule\Container\LinkContainer
        arguments:
            - '@router'
            - '@cmfcmf_media_module.security_manager'
            - '@translator'
            - '@doctrine.orm.default_entity_manager'
        tags: ['zikula.link_container']


    # Collection of media types
    cmfcmf_media_module.media_type_collection:
        class: Cmfcmf\Module\MediaModule\MediaType\MediaTypeCollection
        lazy: true


    # Collection of "Collection" templates
    cmfcmf_media_module.collection_template_collection:
        class: Cmfcmf\Module\MediaModule\CollectionTemplate\TemplateCollection
        lazy: true


    # Selected collection template factory
    cmfcmf_media_module.collection_template.selected_factory:
        class: Cmfcmf\Module\MediaModule\CollectionTemplate\SelectedTemplateFactory
        arguments:
            - '@cmfcmf_media_module.collection_template_collection'

    # Twig extension
    cmfcmf_media_module.twig_extension:
        class: Cmfcmf\Module\MediaModule\Twig\TwigExtension
        arguments:
            - '@translator'
            - '@zikula_core.common.markdown_extra_parser'
            - '@hook_dispatcher'
            - '@cmfcmf_media_module.security_manager'
            - '@cmfcmf_media_module.upgrade.version_checker'
            - '@zikula_extensions_module.extension_repository'
            - '@zikula_extensions_module.api.variable'
        public: false
        tags: ['twig.extension']


    # Fonts
    cmfcmf_media_module.font.font_loader:
        class: Cmfcmf\Module\MediaModule\Font\FontLoader
        tags: ['cmfcmf_media_module.font']
            
    cmfcmf_media_module.font_collection:
        class: Cmfcmf\Module\MediaModule\Font\FontCollection

parameters:
    liip_imagine.cache.signer.class: Cmfcmf\Module\MediaModule\Imagine\Cache\DummySigner
